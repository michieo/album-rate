<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlbumRate</title>

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                        purple: { 500: '#a855f7', 600: '#9333ea' }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Checkbox for Toggles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: currentColor;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: currentColor;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 font-sans antialiased overflow-hidden h-screen flex flex-nowrap">

    <!-- Sidebar -->
    <aside
        class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col hidden md:flex h-full shadow-xl z-20 shrink-0">
        <div class="p-6 border-b border-gray-800 flex items-center gap-3">
            <i class="fa-solid fa-record-vinyl text-gold-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wider">AlbumRate</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <!-- Rate Button -->
            <button onclick="window.Modals.openRateStep1()"
                class="w-full bg-gold-500 hover:bg-gold-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg mb-6 flex items-center justify-center gap-2 transition-transform hover:scale-[1.02]">
                <i class="fa-solid fa-plus"></i> Rate Album
            </button>

            <button onclick="window.router.navigate('dashboard')"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-3"
                id="nav-dashboard">
                <i class="fa-solid fa-chart-line w-6 text-center"></i> Dashboard
            </button>
            <button onclick="window.router.navigate('albums')"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-3"
                id="nav-albums">
                <i class="fa-solid fa-compact-disc w-6 text-center"></i> Albums
            </button>
            <button onclick="window.router.navigate('songs')"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-3"
                id="nav-songs">
                <i class="fa-solid fa-music w-6 text-center"></i> Songs
            </button>
            <button onclick="window.router.navigate('artists')"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-3"
                id="nav-artists">
                <i class="fa-solid fa-users w-6 text-center"></i> Artists
            </button>
            <button onclick="window.router.navigate('settings')"
                class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 transition-colors flex items-center gap-3"
                id="nav-settings">
                <i class="fa-solid fa-cog w-6 text-center"></i> Settings
            </button>

            <div class="mt-8 pt-6 border-t border-gray-800">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4 px-2">Up Next Queue</h3>
                <div id="sidebar-up-next" class="space-y-3 px-2"></div>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
            &copy; 2025 AlbumRate System
        </div>
    </aside>

    <!-- Mobile Header -->
    <div
        class="md:hidden fixed top-0 left-0 right-0 h-16 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 z-30">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-record-vinyl text-gold-500 text-xl"></i>
            <span class="font-bold">AlbumRate</span>
        </div>
        <button onclick="toggleMobileMenu()" class="text-gray-300 hover:text-white">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu"
        class="fixed inset-0 bg-gray-950/95 z-40 hidden flex-col items-center justify-center space-y-6 md:hidden">
        <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i
                class="fa-solid fa-times text-2xl"></i></button>
        <button onclick="window.router.navigate('dashboard'); toggleMobileMenu()"
            class="text-2xl font-bold hover:text-gold-500">Dashboard</button>
        <button onclick="window.router.navigate('albums'); toggleMobileMenu()"
            class="text-2xl font-bold hover:text-gold-500">Albums</button>
        <button onclick="window.router.navigate('songs'); toggleMobileMenu()"
            class="text-2xl font-bold hover:text-gold-500">Songs</button>
        <button onclick="window.router.navigate('artists'); toggleMobileMenu()"
            class="text-2xl font-bold hover:text-gold-500">Artists</button>
    </div>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto bg-gray-950 relative pt-16 md:pt-0 min-w-0" id="main-content"></main>

    <!-- Modals -->
    <div id="modal-container"
        class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/70 backdrop-blur-sm p-4"></div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-20 transition-transform duration-300 z-50 flex items-center gap-3">
        <i id="toast-icon" class="fa-solid fa-check-circle text-green-500"></i>
        <span id="toast-message">Operation successful</span>
    </div>

    <!-- Hidden Datalist -->
    <datalist id="artist-list"></datalist>

    <script>
        // --- Utilities ---
        window.UTILS = {
            generateId: () => Math.random().toString(36).substr(2, 9),
            getScoreColor: (score) => {
                if (score >= 110) return 'bg-purple-600 text-purple-500';
                if (score >= 70) return 'bg-green-500 text-green-500';
                if (score >= 40) return 'bg-orange-500 text-orange-500';
                return 'bg-red-500 text-red-500';
            },
            getScoreHex: (score) => {
                if (score >= 110) return '#9333ea';
                if (score >= 90) return '#4ade80';
                if (score >= 80) return '#22c55e';
                if (score >= 70) return '#16a34a';
                if (score >= 60) return '#a3e635';
                if (score >= 50) return '#facc15';
                if (score >= 40) return '#fb923c';
                return '#f87171';
            },
            formatDate: (dateStr) => {
                if (!dateStr) return 'Unknown';
                return new Date(dateStr).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            },
            compress: (data) => LZString.compressToUTF16(JSON.stringify(data)),
            decompress: (str) => JSON.parse(LZString.decompressFromUTF16(str)),
            imgFallback: (el) => {
                el.onerror = null;
                el.style.display = 'none';
                const fallback = document.createElement('div');
                fallback.className = "w-full h-full bg-gray-800 flex items-center justify-center text-gray-600 absolute inset-0";
                fallback.innerHTML = '<i class="fa-solid fa-compact-disc text-3xl"></i>';
                if (el.parentElement) el.parentElement.appendChild(fallback);
            },
            artistImgFallback: (el) => {
                el.onerror = null;
                el.style.display = 'none';
                const parent = el.parentElement;
                if (parent && !parent.querySelector('.artist-placeholder')) {
                    const fallback = document.createElement('div');
                    fallback.className = "artist-placeholder w-full h-full bg-gray-800 flex items-center justify-center text-gray-600 absolute inset-0 top-0 left-0 z-0";
                    fallback.innerHTML = '<i class="fa-solid fa-user text-2xl"></i>';
                    parent.insertBefore(fallback, parent.firstChild);
                }
            },
            updateDatalist: () => {
                const list = document.getElementById('artist-list');
                if (list) list.innerHTML = window.state.artists.map(a => `<option value="${a.name}"></option>`).join('');
            },
            autoResize: (el) => {
                if (!el) return;
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            }
        };

        // --- State ---
        const INITIAL_STATE = {
            albums: [],
            artists: [],
            history: [],
            settings: {
                customTopAlbums: [],
                customTopArtists: [],
                scoringGuide: "110 = Transcendent\n100 = Masterpiece\n90 = Amazing\n80 = Great\n70 = Good\n60 = Okay\n50 = Mediocre\n<50 = Bad"
            }
        };

        window.state = { ...INITIAL_STATE };
        window.currentChart = null;
        window.sessionStartScore = null;
        window.editMode = false;
        window.songsSortDir = 'desc';

        window.toggleSelection = (type, id) => {
            const list = type === 'albums' ? window.state.settings.customTopAlbums : window.state.settings.customTopArtists;
            const idx = list.indexOf(id);
            if (idx > -1) {
                list.splice(idx, 1);
            } else {
                if (list.length >= 5) {
                    window.showToast('Max 5 selected', 'error');
                    return;
                }
                list.push(id);
            }
            window.Storage.save();
            window.renderSelList(document.querySelector('#sel-search-input')?.value || '');
        };

        window.Storage = {
            save: () => {
                try {
                    localStorage.setItem('albumRateData', UTILS.compress(window.state));
                    UTILS.updateDatalist();
                    window.renderSidebarQueue();
                } catch (e) { showToast('Storage full!', 'error'); }
            },
            load: () => {
                const data = localStorage.getItem('albumRateData');
                if (data) {
                    try {
                        const loaded = UTILS.decompress(data);
                        window.state = { ...INITIAL_STATE, ...loaded };
                        if (!window.state.artists) window.state.artists = [];
                        if (!window.state.albums) window.state.albums = [];
                        if (!window.state.history) window.state.history = [];
                    }
                    catch (e) { showToast('Data corrupted', 'error'); }
                }
                UTILS.updateDatalist();
                window.renderSidebarQueue();
            },
            export: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.state, null, 2));
                const a = document.createElement('a');
                a.href = dataStr; a.download = "album_ratings_backup.json";
                a.click();
            },
            import: (event) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (parsed.albums) {
                            window.state = { ...INITIAL_STATE, ...parsed };
                            window.Storage.save();
                            window.router.navigate('dashboard');
                            showToast('Imported!');
                        }
                    } catch (err) { showToast('Invalid file', 'error'); }
                };
                reader.readAsText(event.target.files[0]);
            }
        };

        // --- Core Logic ---
        function calculateAlbumScore(album) {
            const included = album.tracks.filter(t => !t.exclude);
            if (included.length === 0) return 0;
            const sum = included.reduce((acc, t) => acc + (parseInt(t.score) || 0), 0);
            const avg = sum / included.length;
            const bonus = parseFloat(album.bonus) || 0;
            const final = avg + bonus;
            return parseFloat(final.toFixed(1));
        }

        function getArtist(id) {
            return window.state.artists.find(a => a.id === id) || { name: 'Unknown', image: '', id: 'unknown' };
        }

        function getArtistAvg(artistId) {
            const albums = window.state.albums.filter(a => a.artistId === artistId && a.status === 'Rated');
            if (albums.length === 0) return 0;
            const total = albums.reduce((acc, a) => acc + (a.score || 0), 0);
            return (total / albums.length).toFixed(1);
        }

        // --- GLOBAL RENDER HELPERS (Must be defined before Views) ---
        window.renderTrackRow = (album, track, idx) => {
            const feats = Array.isArray(track.features) ? track.features : (track.features ? track.features.split(',') : []);
            return `
            <div class="flex items-center gap-3 p-3 bg-gray-900 rounded-lg border border-gray-800 hover:border-gray-700 transition-all ${track.exclude ? 'opacity-50 grayscale' : ''}" id="track-row-${idx}">
                <div class="w-8 text-center text-gray-500 font-mono text-sm shrink-0">${idx + 1}</div>
                <div class="flex-1 min-w-0 flex flex-col gap-1">
                    ${window.editMode
                    ? `<input type="text" value="${track.title}" class="bg-gray-950 border border-gray-700 rounded px-2 py-1 text-sm text-white w-full" onchange="window.updateTrackName('${album.id}', ${idx}, this.value)">`
                    : `<div class="font-medium text-gray-200 truncate ${track.exclude ? 'line-through' : ''}" title="${track.title}">${track.title}</div>`
                }
                    <div class="flex flex-wrap gap-1 items-center">
                        ${feats.map(f => `
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-800 text-gold-400 border border-gray-700">
                                ${f} ${window.editMode ? `<button onclick="window.removeFeature('${album.id}', ${idx}, '${f}')" class="ml-1 text-gray-500 hover:text-red-500"><i class="fa-solid fa-times"></i></button>` : ''}
                            </span>
                        `).join('')}
                        ${window.editMode ? `<input type="text" list="artist-list" placeholder="+ Feat" class="bg-transparent border-b border-gray-700 text-[10px] text-gray-300 focus:outline-none focus:border-gold-500 w-16 focus:w-24 transition-all" onkeydown="window.handleAddFeature(event, '${album.id}', ${idx})">` : ''}
                    </div>
                </div>
                <div class="w-24 flex items-center justify-center gap-1 shrink-0">
                    <button onclick="window.setTrackFlagDOM('${album.id}', ${idx}, 'up', this)" class="w-6 h-6 rounded flex items-center justify-center hover:bg-gray-700 ${track.flag === 'up' ? 'text-green-500 bg-gray-800' : 'text-gray-600'}"><i class="fa-solid fa-chevron-up text-xs"></i></button>
                    <button onclick="window.setTrackFlagDOM('${album.id}', ${idx}, 'down', this)" class="w-6 h-6 rounded flex items-center justify-center hover:bg-gray-700 ${track.flag === 'down' ? 'text-red-500 bg-gray-800' : 'text-gray-600'}"><i class="fa-solid fa-chevron-down text-xs"></i></button>
                    <button onclick="window.setTrackFlagDOM('${album.id}', ${idx}, 'asterisk', this)" class="w-6 h-6 rounded flex items-center justify-center hover:bg-gray-700 ${track.flag === 'asterisk' ? 'text-blue-500 bg-gray-800' : 'text-gray-600'}"><i class="fa-solid fa-asterisk text-[10px]"></i></button>
                </div>
                <div class="w-10 text-center shrink-0">
                    <button onclick="window.toggleExcludeDOM('${album.id}', ${idx}, this)" class="text-gray-500 hover:text-white transition-colors" title="Exclude from Average">
                        <i class="fa-solid ${track.exclude ? 'fa-ban text-red-500' : 'fa-circle-check text-gray-700'}"></i>
                    </button>
                </div>
                <div class="w-16 shrink-0">
                    <input type="number" min="0" max="110" value="${track.score}" 
                        id="score-input-${idx}"
                        oninput="window.updateTrackScore('${album.id}', ${idx}, this.value)"
                        class="w-full bg-gray-950 border border-gray-700 rounded py-2 text-center font-bold text-lg focus:ring-1 focus:ring-gold-500 focus:outline-none ${UTILS.getScoreColor(track.score).split(' ')[1]} transition-colors duration-200">
                </div>
                ${window.editMode ? `<button onclick="window.deleteTrack('${album.id}', ${idx})" class="text-red-500 hover:text-white px-2"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>
            `;
        };

        window.getButtonClass = (album, tag, color) => {
            const isActive = album.tags.includes(tag);
            const map = { purple: 'bg-purple-600 border-purple-600 text-white', green: 'bg-green-600 border-green-600 text-white', red: 'bg-red-600 border-red-600 text-white' };
            return isActive ? map[color] : `bg-transparent border-gray-600 text-gray-400 hover:border-${color}-600 hover:text-${color}-500`;
        };

        // --- Router ---
        window.router = {
            current: 'dashboard',
            historyStack: [],
            navigate: (view, param = null) => {
                // SAVE HISTORY ON LEAVE
                if (window.router.current === 'rate' && window.router.currentParam && view !== 'rate') {
                    const prevId = window.router.currentParam;
                    const alb = window.state.albums.find(a => a.id === prevId);
                    // Check if score changed
                    if (alb && window.sessionStartScore !== null && alb.score !== window.sessionStartScore) {
                        window.state.history.push({
                            date: Date.now(),
                            albumId: alb.id,
                            score: alb.score,
                            oldScore: window.sessionStartScore
                        });
                        window.Storage.save();
                    }
                    window.sessionStartScore = null;
                }

                if (window.router.current !== view) {
                    window.router.historyStack.push({ view: window.router.current, param: window.router.currentParam });
                    window.editMode = false;
                }

                window.router.current = view;
                window.router.currentParam = param;

                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('bg-gray-800', 'text-gold-400');
                    el.classList.add('text-gray-300');
                });
                const nav = document.getElementById(`nav-${view}`);
                if (nav) { nav.classList.add('bg-gray-800', 'text-gold-400'); nav.classList.remove('text-gray-300'); }

                const main = document.getElementById('main-content');
                main.innerHTML = '';

                if (view === 'rate') {
                    const alb = window.state.albums.find(a => a.id === param);
                    if (alb) window.sessionStartScore = alb.score;
                }

                try {
                    switch (view) {
                        case 'dashboard': window.Views.renderDashboard(main); break;
                        case 'albums': window.Views.renderAlbums(main); break;
                        case 'songs': window.Views.renderSongsLogic(main); break;
                        case 'artists': window.Views.renderArtists(main); break;
                        case 'settings': window.Views.renderSettingsLogic(main); break;
                        case 'rate': window.Views.renderRating(main, param); break;
                        case 'artistProfile': window.Views.renderArtistProfile(main, param); break;
                        case 'bestByYear': window.Views.renderBestByYear(main); break;
                    }
                } catch (e) {
                    console.error("Render Error:", e);
                    main.innerHTML = `<div class="p-10 text-red-500">Error rendering view: ${e.message}</div>`;
                }
                window.renderSidebarQueue();
            },
            back: () => {
                if (window.router.historyStack.length > 0) {
                    const prev = window.router.historyStack.pop();
                    window.router.navigate(prev.view, prev.param);
                    window.router.historyStack.pop();
                } else {
                    window.router.navigate('dashboard');
                }
            }
        };

        // --- VIEWS ---
        window.Views = {
            renderDashboard: (container) => {
                const ratedAlbums = window.state.albums.filter(a => a.status === 'Rated');
                const customTopAlbums = window.state.settings.customTopAlbums.map(id => window.state.albums.find(a => a.id === id)).filter(Boolean);
                const customTopArtists = window.state.settings.customTopArtists.map(id => window.state.artists.find(a => a.id === id)).filter(Boolean);
                const sortedByDate = [...ratedAlbums].sort((a, b) => (b.dateRated || b.dateAdded) - (a.dateRated || a.dateAdded)).slice(0, 8);

                const ranges = [
                    { min: 100, label: '100+' }, { min: 90, max: 99, label: '90-99' }, { min: 80, max: 89, label: '80-89' },
                    { min: 70, max: 79, label: '70-79' }, { min: 60, max: 69, label: '60-69' }, { min: 50, max: 59, label: '50-59' },
                    { min: 40, max: 49, label: '40-49' }, { min: 30, max: 39, label: '30-39' }, { min: 20, max: 29, label: '20-29' },
                    { min: 10, max: 19, label: '10-19' }, { min: 0, max: 9, label: '0-9' }
                ];
                const labels = ranges.map(r => r.label);
                const dataPoints = ranges.map(r => ratedAlbums.filter(a => { const s = a.score || 0; return r.max !== undefined ? (s >= r.min && s <= r.max) : (s >= r.min); }).length);
                const bgColors = labels.map((l, i) => UTILS.getScoreHex(ranges[i].min));

                container.innerHTML = `
                    <div class="p-6 md:p-10 space-y-8 max-w-7xl mx-auto fade-in h-full flex flex-col">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                            <div class="text-gray-400">Total Rated: <span class="text-gold-400 font-bold">${ratedAlbums.filter(a => a.type !== 'Single').length}</span></div>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-8 pr-2">
                            <!-- Top Albums -->
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                                <div class="flex justify-between mb-4">
                                    <h3 class="font-bold text-xl text-gold-400">Top 5 Albums</h3>
                                    <button onclick="window.Modals.openSelectionModal('albums')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded border border-gray-700">Edit</button>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    ${customTopAlbums.length ? customTopAlbums.map((a, i) => `
                                        <div class="group cursor-pointer" onclick="window.router.navigate('rate', '${a.id}')">
                                            <div class="relative aspect-square mb-2 overflow-hidden rounded-lg shadow-lg bg-gray-800">
                                                <img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                                <div class="absolute top-0 left-0 bg-black/70 text-white font-bold px-2 py-1 rounded-br text-xs">#${i + 1}</div>
                                            </div>
                                            <div class="font-bold text-sm truncate text-white group-hover:text-gold-400">${a.title}</div>
                                            <div class="text-xs text-gray-500 truncate">${getArtist(a.artistId).name}</div>
                                        </div>
                                    `).join('') : '<div class="col-span-5 text-gray-600 italic">Select your top albums.</div>'}
                                </div>
                            </div>

                            <!-- Top Artists -->
                            <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                                <div class="flex justify-between mb-4">
                                    <h3 class="font-bold text-xl text-purple-400">Top 5 Artists</h3>
                                    <button onclick="window.Modals.openSelectionModal('artists')" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded border border-gray-700">Edit</button>
                                </div>
                                <div class="flex justify-around flex-wrap gap-4">
                                    ${customTopArtists.length ? customTopArtists.map((a, i) => `
                                        <div class="group cursor-pointer flex flex-col items-center w-24 md:w-32" onclick="window.router.navigate('artistProfile', '${a.id}')">
                                            <div class="w-24 h-24 md:w-32 md:h-32 mb-2 rounded-full overflow-hidden border-4 border-gray-800 shadow-lg group-hover:border-purple-500 transition-all bg-gray-800 relative">
                                                ${!a.image ? `<div class="absolute inset-0 bg-gray-800 flex items-center justify-center"><i class="fa-solid fa-user text-gray-600 text-3xl"></i></div>` : ''}
                                                <img src="${a.image}" onerror="UTILS.artistImgFallback(this)" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                            </div>
                                            <div class="font-bold text-sm truncate text-white w-full text-center">${a.name}</div>
                                        </div>
                                    `).join('') : '<div class="w-full text-gray-600 italic text-center">Select your top artists.</div>'}
                                </div>
                            </div>

                            <!-- Stats & Recent -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 lg:col-span-2">
                                    <h3 class="font-bold text-lg text-gray-300 mb-4">Score Distribution</h3>
                                    <div class="h-64 md:w-2/3 mx-auto"><canvas id="distChart"></canvas></div>
                                </div>
                                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 flex flex-col">
                                    <h3 class="font-bold text-lg text-gray-300 mb-4">Recently Rated</h3>
                                    <div class="flex-1 overflow-y-auto space-y-2 max-h-64">
                                        ${sortedByDate.map(a => `
                                            <div class="flex items-center gap-3 p-2 hover:bg-gray-800 rounded cursor-pointer group" onclick="window.router.navigate('rate', '${a.id}')">
                                                <img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-10 h-10 rounded object-cover bg-gray-800">
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-bold truncate">${a.title}</div>
                                                    <div class="text-[10px] text-gray-500">${UTILS.formatDate(a.dateRated || a.dateAdded)}</div>
                                                </div>
                                                <div class="font-bold ${UTILS.getScoreColor(a.score).split(' ')[1]}">${a.score}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    new Chart(document.getElementById('distChart'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{ label: 'Count', data: dataPoints, backgroundColor: bgColors, borderRadius: 4 }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { grid: { color: '#374151' } } }
                        }
                    });
                }, 50);
            },

            renderAlbums: (container) => {
                let html = `
                    <div class="p-6 md:p-10 space-y-6 max-w-7xl mx-auto h-full flex flex-col fade-in">
                        <div class="flex flex-col xl:flex-row justify-between xl:items-center gap-4">
                            <h2 class="text-3xl font-bold">My Albums</h2>
                            <div class="flex flex-col md:flex-row gap-4 items-center flex-wrap">
                                <button onclick="window.router.navigate('bestByYear')" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded text-xs font-bold hover:bg-gray-700">Best By Year</button>
                                <input type="text" id="album-search" placeholder="Search..." class="bg-gray-800 border-none rounded px-4 py-2 text-sm focus:ring-1 focus:ring-gold-500 w-full md:w-48" oninput="window.Views.refreshAlbumGrid()">
                                <div class="flex bg-gray-800 rounded p-1 gap-1" id="type-filters">
                                    ${['Album', 'EP', 'Mixtape', 'Single'].map(t => `
                                        <button class="px-3 py-1 text-xs rounded hover:bg-gray-700 transition-colors text-gray-400 type-filter-btn" data-type="${t}" onclick="window.toggleTypeFilter(this)">${t}</button>
                                    `).join('')}
                                </div>
                                <select id="album-sort" class="bg-gray-800 border-none rounded px-4 py-2 text-sm focus:ring-1 focus:ring-gold-500" onchange="window.Views.refreshAlbumGrid()">
                                    <option value="score-desc">Highest Ranked</option>
                                    <option value="score-asc">Lowest Ranked</option>
                                    <option value="date-desc">Newest Added</option>
                                    <option value="name-asc">Name (A-Z)</option>
                                </select>
                                <div class="flex gap-2">
                                    <button class="w-8 h-8 rounded-full bg-gray-800 text-gray-500 hover:text-red-500 flex items-center justify-center transition-colors filter-icon-btn" data-filter="Heart" onclick="window.toggleIconFilter(this, 'text-red-500')"><i class="fa-solid fa-heart"></i></button>
                                    <button class="w-8 h-8 rounded-full bg-gray-800 text-gray-500 hover:text-purple-500 flex items-center justify-center transition-colors filter-icon-btn" data-filter="Redo" onclick="window.toggleIconFilter(this, 'text-purple-500')"><i class="fa-solid fa-rotate-right"></i></button>
                                    <button class="w-8 h-8 rounded-full bg-gray-800 text-gray-500 hover:text-blue-500 flex items-center justify-center transition-colors filter-icon-btn" data-filter="In Progress" onclick="window.toggleIconFilter(this, 'text-blue-500')"><i class="fa-solid fa-hourglass-half"></i></button>
                                    <button class="w-8 h-8 rounded-full bg-gray-800 text-gray-500 hover:text-gold-500 flex items-center justify-center transition-colors filter-icon-btn" data-filter="HasFlags" onclick="window.toggleIconFilter(this, 'text-gold-500')"><i class="fa-solid fa-asterisk"></i></button>
                                </div>
                            </div>
                        </div>
                        <div id="album-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 overflow-y-auto pb-20"></div>
                    </div>
                `;
                container.innerHTML = html;
                window.Views.refreshAlbumGrid();
            },
            refreshAlbumGrid: () => {
                const search = document.getElementById('album-search').value.toLowerCase();
                const sort = document.getElementById('album-sort').value;
                const activeTypes = Array.from(document.querySelectorAll('.type-filter-btn.bg-gold-500')).map(b => b.dataset.type);
                const activeTags = Array.from(document.querySelectorAll('.filter-icon-btn.active-filter')).map(b => b.dataset.filter);

                let filtered = window.state.albums.filter(a => {
                    const artist = getArtist(a.artistId);
                    const matchesSearch = a.title.toLowerCase().includes(search) || artist.name.toLowerCase().includes(search);
                    const matchesType = activeTypes.length === 0 || activeTypes.includes(a.type);
                    const matchesTags = activeTags.every(tag => {
                        if (tag === 'In Progress') return a.tags.includes(tag) || a.status === 'In Progress';
                        if (tag === 'HasFlags') return a.tracks && a.tracks.some(t => t.flag);
                        return a.tags.includes(tag);
                    });
                    return matchesSearch && matchesType && matchesTags;
                });

                filtered.sort((a, b) => {
                    if (sort === 'date-desc') return (b.dateAdded || 0) - (a.dateAdded || 0);
                    if (sort === 'score-desc') return (b.score || 0) - (a.score || 0);
                    if (sort === 'score-asc') return (a.score || 0) - (b.score || 0);
                    if (sort === 'name-asc') return a.title.localeCompare(b.title);
                });

                document.getElementById('album-grid').innerHTML = filtered.map(a => {
                    const artist = getArtist(a.artistId);
                    const colorClass = UTILS.getScoreColor(a.score || 0);
                    const bgClass = colorClass.split(' ')[0];
                    const textClass = colorClass.split(' ')[1];
                    const hasFlags = a.tracks && a.tracks.some(t => t.flag);

                    return `
                        <div class="bg-gray-900 rounded-lg overflow-hidden group shadow-md hover:shadow-xl transition-all border border-gray-800 flex flex-col cursor-pointer relative" onclick="window.router.navigate('rate', '${a.id}')">
                            ${hasFlags ? '<div class="absolute top-2 left-2 z-10 text-blue-400 bg-black/50 rounded-full w-6 h-6 flex items-center justify-center"><i class="fa-solid fa-asterisk text-xs"></i></div>' : ''}
                            
                            <!-- DELETE BUTTON -->
                            <button onclick="event.stopPropagation(); window.deleteAlbumFromGrid('${a.id}')" class="absolute top-2 left-2 z-30 bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700 shadow-lg" title="Delete Album">
                                <i class="fa-solid fa-trash text-[10px]"></i>
                            </button>

                            <div class="relative aspect-square bg-gray-800">
                                <img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover">
                                <div class="absolute top-2 right-2 text-[10px] bg-black/70 text-white px-1.5 py-0.5 rounded border border-gray-700 backdrop-blur-sm">${a.type || 'Album'}</div>
                            </div>
                            <div class="p-3 flex-1 flex flex-col">
                                <h4 class="font-bold text-sm truncate" title="${a.title}">${a.title}</h4>
                                <p class="text-xs text-gray-400 truncate">${artist.name}</p>
                                <div class="mt-auto pt-3">
                                    <div class="text-3xl font-black ${textClass} drop-shadow-md leading-none mb-1">${a.score || 0}</div>
                                    <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full ${bgClass}" style="width: ${Math.min(a.score || 0, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderBestByYear: (container) => {
                const years = {};
                window.state.albums.filter(a => a.status === 'Rated').forEach(a => {
                    const y = a.releaseDate ? a.releaseDate.split('-')[0] : (a.year || 'Unknown');
                    if (!years[y]) years[y] = [];
                    years[y].push(a);
                });

                const sortedYears = Object.keys(years).sort((a, b) => b - a);

                container.innerHTML = `
                    <div class="p-6 md:p-10 space-y-8 max-w-5xl mx-auto fade-in">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="window.router.back()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                            <h2 class="text-3xl font-bold">Best Albums by Year</h2>
                        </div>
                        <div class="space-y-12">
                            ${sortedYears.map(year => {
                    const albums = years[year].sort((a, b) => b.score - a.score).slice(0, 5);
                    return `
                                    <div>
                                        <h3 class="text-2xl font-bold text-gold-400 mb-4 border-b border-gray-800 pb-2">${year}</h3>
                                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                            ${albums.map((a, i) => `
                                                <div class="cursor-pointer group" onclick="window.router.navigate('rate', '${a.id}')">
                                                    <div class="relative aspect-square mb-2 bg-gray-800 rounded overflow-hidden">
                                                        <img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover">
                                                        <div class="absolute top-0 left-0 bg-black/70 text-white font-bold px-2 py-1 rounded-br text-xs">#${i + 1}</div>
                                                    </div>
                                                    <div class="font-bold text-sm truncate text-white">${a.title}</div>
                                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                                        <span class="truncate max-w-[70%]">${getArtist(a.artistId).name}</span>
                                                        <span class="font-bold ${UTILS.getScoreColor(a.score).split(' ')[1]}">${a.score}</span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            },

            renderSongsLogic: (container) => {
                window.Views.renderSongsLogicImpl(container);
            },
            renderSongsLogicImpl: (container) => {
                const yearFilter = window.songsYearFilter || 'All';
                const sortDir = window.songsSortDir || 'desc';

                const years = new Set();
                window.state.albums.forEach(a => {
                    const y = a.releaseDate ? a.releaseDate.split('-')[0] : (a.year || 'Unknown');
                    years.add(y);
                });
                const sortedYears = Array.from(years).sort().reverse();

                let allSongs = [];
                window.state.albums.filter(a => a.status === 'Rated').forEach(album => {
                    const y = album.releaseDate ? album.releaseDate.split('-')[0] : (album.year || 'Unknown');
                    if (yearFilter === 'All' || y == yearFilter) {
                        album.tracks.forEach((track, idx) => {
                            if (!track.exclude) allSongs.push({ ...track, album, trackNum: idx });
                        });
                    }
                });

                allSongs.sort((a, b) => sortDir === 'desc' ? b.score - a.score : a.score - b.score);

                container.innerHTML = `
                    <div class="p-6 md:p-10 space-y-6 max-w-7xl mx-auto h-full flex flex-col fade-in">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold">Top Songs</h2>
                            <select class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm" onchange="window.songsYearFilter=this.value; window.Views.renderSongsLogic(document.getElementById('main-content'))">
                                <option value="All">All Years</option>
                                ${sortedYears.map(y => `<option value="${y}" ${yearFilter == y ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto pb-20">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900 text-gray-500 sticky top-0 uppercase text-xs z-10">
                                    <tr>
                                        <th class="p-4">#</th>
                                        <th class="p-4">Track</th>
                                        <th class="p-4 hidden md:table-cell">Album</th>
                                        <th class="p-4 text-right cursor-pointer hover:text-white" onclick="window.songsSortDir = window.songsSortDir === 'desc' ? 'asc' : 'desc'; window.Views.renderSongsLogic(document.getElementById('main-content'))">
                                            Score <i class="fa-solid fa-sort"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">
                                    ${allSongs.map((song, i) => `
                                        <tr class="hover:bg-gray-800/50 cursor-pointer group" onclick="window.router.navigate('rate', '${song.album.id}')">
                                            <td class="p-4 font-mono text-gray-600">${i + 1}</td>
                                            <td class="p-4">
                                                <div class="flex items-center gap-3">
                                                    <img src="${song.album.cover}" onerror="UTILS.imgFallback(this)" class="w-10 h-10 rounded bg-gray-700">
                                                    <div>
                                                        <div class="font-bold text-gray-200 group-hover:text-gold-400">${song.title}</div>
                                                        <div class="text-xs text-gray-500">${getArtist(song.album.artistId).name}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="p-4 hidden md:table-cell">${song.album.title}</td>
                                            <td class="p-4 text-right">
                                                <div class="font-bold text-lg ${UTILS.getScoreColor(song.score).split(' ')[1]}">${song.score}</div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            renderRating: (container, albumId) => {
                const album = window.state.albums.find(a => a.id === albumId);
                if (!album) return window.router.navigate('dashboard');
                const artist = getArtist(album.artistId);
                const isRated = album.status === 'Rated';

                if (window.currentChart) { window.currentChart.destroy(); window.currentChart = null; }

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-gray-950 fade-in min-w-0">
                        <!-- Header -->
                        <header class="bg-gray-900 border-b border-gray-800 p-4 flex items-center justify-between z-10 shrink-0 gap-4">
                            <div class="flex items-center gap-4 min-w-0 flex-1">
                                <button onclick="window.router.back()" class="text-gray-400 hover:text-white shrink-0"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                                <img src="${album.cover}" onerror="UTILS.imgFallback(this)" class="w-12 h-12 rounded object-cover border border-gray-700 shrink-0">
                                <div class="min-w-0">
                                    <h2 class="font-bold text-lg leading-tight truncate">${album.title}</h2>
                                    <div class="text-xs text-gray-400 truncate">${artist.name} • ${album.type || 'Album'} • ${UTILS.formatDate(album.releaseDate)}</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                                <span class="text-xs font-bold ${album.status === 'Rated' ? 'text-green-500' : 'text-blue-500'} uppercase w-20 text-center" id="status-label">${album.status}</span>
                                <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in ${album.status === 'Rated' ? 'text-green-600' : 'text-blue-600'}">
                                    <input type="checkbox" id="status-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${album.status === 'Rated' ? 'checked' : ''} onchange="window.toggleAlbumStatus('${album.id}')"/>
                                    <label for="status-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-700 cursor-pointer"></label>
                                </div>
                            </div>

                            <div class="flex items-center gap-4 flex-1 justify-end">
                                <button onclick="window.Modals.showHistory('${album.id}')" class="text-gray-500 hover:text-white" title="History"><i class="fa-solid fa-clock-rotate-left"></i></button>
                                <button onclick="window.toggleEditMode('${album.id}')" class="text-xs px-3 py-1.5 rounded border ${window.editMode ? 'bg-blue-600 border-blue-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300'}">Edit Details</button>
                            </div>
                        </header>

                        <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
                            <!-- Sidebar Controls -->
                            <div class="lg:w-1/3 bg-gray-900 border-r border-gray-800 p-6 overflow-y-auto flex flex-col gap-6 shrink-0">
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 uppercase font-bold tracking-widest">Current Score</div>
                                    <div class="text-6xl font-black text-white drop-shadow-xl mt-2 ${UTILS.getScoreColor(album.score).split(' ')[1]}" id="rating-score-display">${album.score || 0}</div>
                                </div>
                                <div class="bg-gray-850 p-4 rounded-xl border border-gray-800 shadow-inner">
                                    <div class="chart-container"><canvas id="scoreChart"></canvas></div>
                                </div>
                                
                                ${window.editMode ? `
                                    <div class="bg-blue-900/20 p-4 rounded border border-blue-800 space-y-3">
                                        <div class="text-xs text-blue-400 font-bold uppercase">Editing Metadata</div>
                                        <input type="text" value="${album.title}" class="w-full bg-gray-950 border border-gray-700 rounded px-2 py-1 text-sm text-white" onchange="window.updateAlbumMeta('${album.id}', 'title', this.value)">
                                        <input type="date" value="${album.releaseDate}" class="w-full bg-gray-950 border border-gray-700 rounded px-2 py-1 text-sm text-white" onchange="window.updateAlbumMeta('${album.id}', 'releaseDate', this.value)">
                                        <div class="text-xs text-gray-500 mt-2">Rated Date:</div>
                                        <input type="date" value="${album.dateRated ? new Date(album.dateRated).toISOString().split('T')[0] : ''}" class="w-full bg-gray-950 border border-gray-700 rounded px-2 py-1 text-sm text-white" onchange="window.updateDateRated('${album.id}', this.value)">
                                    </div>
                                ` : ''}

                                <div class="bg-gray-850 p-4 rounded-lg border border-gray-800 space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="window.toggleTagDOM('${album.id}', 'Redo', this)" class="w-full py-2 rounded text-sm font-bold border transition-all ${window.getButtonClass(album, 'Redo', 'purple')}">
                                            <i class="fa-solid fa-rotate-right mr-1"></i> Redo
                                        </button>
                                        <button onclick="window.toggleTagDOM('${album.id}', 'To Listen', this)" class="w-full py-2 rounded text-sm font-bold border transition-all ${window.getButtonClass(album, 'To Listen', 'green')}">
                                            <i class="fa-solid fa-play mr-1"></i> Up Next
                                        </button>
                                    </div>
                                    <button onclick="window.toggleHeartDOM('${album.id}', this)" class="w-full py-2 rounded text-sm font-bold border transition-all ${window.getButtonClass(album, 'Heart', 'red')}">
                                        <i class="fa-solid fa-heart mr-1"></i> Favorite
                                    </button>
                                </div>

                                <div class="bg-gray-850 p-4 rounded-lg border border-gray-800">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Bonus Points</label>
                                    <input type="number" value="${album.bonus || 0}" step="0.1" oninput="window.updateAlbumBonus('${album.id}', this.value)" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-center font-bold text-lg text-white">
                                </div>
                                <div class="bg-gray-850 p-4 rounded-lg border border-gray-800">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Scoring Guide</label>
                                    <div class="text-sm text-gray-300 whitespace-pre-wrap p-2 font-sans">${window.state.settings.scoringGuide}</div>
                                </div>
                                ${window.editMode ? `<button onclick="window.deleteAlbum('${album.id}')" class="text-red-500 text-xs hover:underline text-center w-full">Delete Album</button>` : ''}
                            </div>

                            <!-- Tracklist -->
                            <div class="lg:w-2/3 bg-gray-950 overflow-y-auto p-6 pb-20 min-w-0">
                                <div class="max-w-4xl mx-auto space-y-1">
                                    ${album.tracks.map((t, i) => window.renderTrackRow(album, t, i)).join('')}
                                    ${window.editMode ? `<button onclick="window.addNewTrack('${album.id}')" class="w-full py-3 border-2 border-dashed border-gray-800 text-gray-500 hover:border-gray-600 hover:text-white rounded mt-4 font-bold">+ Add Track</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    initChart(album);
                }, 50);
            },

            renderArtistProfile: (container, id) => {
                const artist = getArtist(id);
                const currentTab = window.artistTab || 'discog';
                const soloAlbums = window.state.albums.filter(a => a.artistId === id);
                const allSongs = [];
                soloAlbums.filter(a => a.status === 'Rated').forEach(a => { a.tracks.forEach(t => { if (!t.exclude) allSongs.push({ ...t, album: a, isFeat: false }); }); });
                window.state.albums.filter(a => a.status === 'Rated' && a.artistId !== id).forEach(a => {
                    a.tracks.forEach(t => {
                        const feats = Array.isArray(t.features) ? t.features : (t.features || '').split(',');
                        if (feats.some(f => f.trim().toLowerCase() === artist.name.toLowerCase())) allSongs.push({ ...t, album: a, isFeat: true });
                    });
                });
                allSongs.sort((a, b) => b.score - a.score);
                soloAlbums.sort((a, b) => (b.releaseDate || b.year || '').localeCompare(a.releaseDate || a.year || ''));

                container.innerHTML = `
                    <div class="flex flex-col h-full bg-gray-950 fade-in">
                        <div class="relative h-64 bg-gray-900 shrink-0">
                            <img src="${artist.image}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover opacity-30">
                            <div class="absolute inset-0 bg-gradient-to-t from-gray-950 to-transparent"></div>
                            <div class="absolute bottom-6 left-6 md:left-12 flex items-end gap-6">
                                <div class="relative group w-32 h-32">
                                    <div class="absolute inset-0 rounded-full border-4 border-gray-950 shadow-2xl bg-gray-800 flex items-center justify-center overflow-hidden">
                                        ${artist.image ?
                        `<img src="${artist.image}" onerror="UTILS.artistImgFallback(this)" class="w-full h-full object-cover">` :
                        `<i class="fa-solid fa-user text-4xl text-gray-600"></i>`
                    }
                                    </div>
                                    <button onclick="window.Modals.editArtist('${artist.id}')" class="absolute bottom-0 right-0 bg-gray-900 text-white p-2 rounded-full border border-gray-600 hover:bg-gold-500 hover:text-black transition-colors shadow-lg z-20"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <div>
                                    <h1 class="text-4xl font-bold text-white">${artist.name}</h1>
                                    <div class="text-gold-400 font-bold text-xl mt-1">Avg: ${getArtistAvg(id)}</div>
                                </div>
                            </div>
                            <button onclick="window.router.back()" class="absolute top-6 right-6 bg-black/50 p-2 rounded text-white"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="p-6 md:p-12 flex-1 overflow-y-auto">
                            <div class="flex gap-4 border-b border-gray-800 pb-4 mb-6">
                                <button onclick="window.artistTab='discog'; window.router.navigate('artistProfile','${id}')" class="px-4 py-2 rounded font-bold ${currentTab === 'discog' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'}">Discography</button>
                                <button onclick="window.artistTab='songs'; window.router.navigate('artistProfile','${id}')" class="px-4 py-2 rounded font-bold ${currentTab === 'songs' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'}">Song Catalog</button>
                            </div>
                            ${currentTab === 'discog' ? `
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${soloAlbums.map(a => `
                                        <div class="bg-gray-900 rounded-lg overflow-hidden group shadow-md hover:shadow-xl transition-all border border-gray-800 flex flex-col cursor-pointer relative" onclick="window.router.navigate('rate', '${a.id}')">
                                            <div class="relative aspect-square bg-gray-800">
                                                <img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover">
                                                <div class="absolute top-2 right-2 text-[10px] bg-black/70 text-white px-1.5 py-0.5 rounded border border-gray-700 backdrop-blur-sm">${a.type}</div>
                                            </div>
                                            <div class="p-3">
                                                <h4 class="font-bold text-sm truncate">${a.title}</h4>
                                                <div class="text-xs text-gray-400">${a.year || (a.releaseDate ? a.releaseDate.split('-')[0] : 'Unknown')}</div>
                                                <div class="mt-2 font-bold ${a.status === 'Rated' ? UTILS.getScoreColor(a.score).split(' ')[1] : 'text-gray-500'}">${a.status === 'Rated' ? a.score : 'Unrated'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${soloAlbums.length === 0 ? '<div class="text-gray-500 italic col-span-full">No albums found.</div>' : ''}
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${allSongs.map((t, i) => `
                                        <div class="flex items-center gap-4 p-3 bg-gray-900 rounded border border-gray-800 hover:border-gray-600 cursor-pointer" onclick="window.router.navigate('rate', '${t.album.id}')">
                                            <div class="font-mono text-gray-500 w-8 text-center">#${i + 1}</div>
                                            <img src="${t.album.cover}" onerror="UTILS.imgFallback(this)" class="w-10 h-10 rounded">
                                            <div class="flex-1">
                                                <div class="font-bold text-gray-200">${t.title}</div>
                                                <div class="text-xs text-gray-500 flex gap-2 items-center"><span>on ${t.album.title}</span>${t.isFeat ? '<span class="px-1.5 rounded bg-blue-900 text-blue-300 text-[10px]">Featured</span>' : ''}</div>
                                            </div>
                                            <div class="font-bold ${UTILS.getScoreColor(t.score).split(' ')[1]}">${t.score}</div>
                                        </div>
                                    `).join('')}
                                    ${allSongs.length === 0 ? '<div class="text-gray-500 italic">No songs found.</div>' : ''}
                                </div>
                            `}
                        </div>
                    </div>`;
            },

            renderArtists: (container) => {
                const sortBy = window.artistSort || 'alpha';
                let list = [...window.state.artists];
                const soloArtists = list.filter(ar => window.state.albums.some(al => al.artistId === ar.id));
                const featureArtists = list.filter(ar => !window.state.albums.some(al => al.artistId === ar.id));
                const sortFn = (a, b) => {
                    if (sortBy === 'rating') return getArtistAvg(b.id) - getArtistAvg(a.id);
                    if (sortBy === 'count') return window.state.albums.filter(x => x.artistId === b.id).length - window.state.albums.filter(x => x.artistId === a.id).length;
                    return a.name.localeCompare(b.name);
                };
                soloArtists.sort(sortFn);
                featureArtists.sort((a, b) => a.name.localeCompare(b.name));

                container.innerHTML = `
                    <div class="p-6 md:p-10 space-y-8 max-w-7xl mx-auto fade-in">
                        <div class="flex justify-between items-center"><h2 class="text-3xl font-bold">Artists Library</h2>
                        <select class="bg-gray-900 border border-gray-700 rounded px-3 py-1 text-sm" onchange="window.artistSort=this.value; window.router.navigate('artists')">
                            <option value="alpha" ${sortBy === 'alpha' ? 'selected' : ''}>Alphabetical</option><option value="rating" ${sortBy === 'rating' ? 'selected' : ''}>Highest Rating</option><option value="count" ${sortBy === 'count' ? 'selected' : ''}>Album Count</option>
                        </select></div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            ${soloArtists.map(a => `
                                <div onclick="window.router.navigate('artistProfile', '${a.id}')" class="cursor-pointer bg-gray-900 p-4 rounded-xl flex flex-col items-center hover:bg-gray-800 transition-colors border border-gray-800 group">
                                    <div class="w-40 h-40 rounded-full overflow-hidden mb-3 border-2 border-gray-800 group-hover:border-gold-500 shadow-lg bg-gray-800 relative">
                                        ${!a.image ? `<div class="absolute inset-0 bg-gray-800 flex items-center justify-center"><i class="fa-solid fa-user text-gray-600 text-3xl"></i></div>` : ''}
                                        <img src="${a.image}" onerror="UTILS.artistImgFallback(this)" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                                    </div>
                                    <h3 class="font-bold text-sm line-clamp-1 text-center">${a.name}</h3>
                                    <div class="mt-2 text-xs px-2 py-1 rounded bg-gray-800 text-gray-400 border border-gray-700">Avg: <span class="${getArtistAvg(a.id) >= 80 ? 'text-green-400' : 'text-gray-300'}">${getArtistAvg(a.id)}</span></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="pt-8 border-t border-gray-800">
                            <button onclick="document.getElementById('feat-artists').classList.toggle('hidden')" class="text-sm font-bold text-gray-500 hover:text-white flex items-center gap-2"><i class="fa-solid fa-chevron-down"></i> Feature-Only Artists (${featureArtists.length})</button>
                            <div id="feat-artists" class="hidden mt-4 grid grid-cols-2 md:grid-cols-6 gap-4 opacity-75">
                                ${featureArtists.map(a => `
                                    <div onclick="window.router.navigate('artistProfile', '${a.id}')" class="cursor-pointer bg-gray-900 p-4 rounded-xl flex flex-col items-center hover:bg-gray-800 transition-colors border border-gray-800 group">
                                        <div class="w-16 h-16 rounded-full overflow-hidden mb-2 grayscale group-hover:grayscale-0 bg-gray-800 relative">
                                            ${!a.image ? `<div class="absolute inset-0 bg-gray-800 flex items-center justify-center"><i class="fa-solid fa-user text-gray-600 text-2xl"></i></div>` : ''}
                                            <img src="${a.image}" onerror="UTILS.artistImgFallback(this)" class="w-full h-full object-cover">
                                        </div>
                                        <h3 class="font-bold text-xs text-center">${a.name}</h3>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            },
            renderSettingsLogic: (container) => {
                const charCount = UTILS.compress(window.state).length;
                const kb = (charCount * 2 / 1024).toFixed(2);
                // Assume 5MB soft limit for visual purposes
                const limit = 5000;
                const percent = Math.min((kb / limit) * 100, 100).toFixed(1);

                container.innerHTML = `
                <div class="p-10 max-w-4xl mx-auto space-y-8 fade-in">
                    <h2 class="text-3xl font-bold border-b border-gray-800 pb-4">Settings</h2>
                    <div class="bg-gray-900 p-6 rounded-lg border border-gray-800">
                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Storage Used: ${kb} KB</span>
                                <span>${percent}% of safe limit</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="bg-gold-500 h-2.5 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="window.Storage.export()" class="bg-gray-800 border border-gray-700 px-4 py-2 rounded text-white hover:bg-gray-700">Export Data</button>
                            <label class="bg-gray-800 border border-gray-700 px-4 py-2 rounded text-white cursor-pointer hover:bg-gray-700">Import Data <input type="file" class="hidden" onchange="window.Storage.import(event)"></label>
                        </div>
                        <button onclick="if(confirm('Clear history?')){window.state.history=[];window.Storage.save();window.showToast('Cleared')}" class="mt-4 text-red-500 text-xs hover:text-red-400">Clear History</button>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Scoring Guide</h3>
                        <textarea onchange="window.state.settings.scoringGuide=this.value;window.Storage.save()" class="w-full bg-gray-900 border border-gray-700 p-4 rounded h-40 text-gray-300 focus:outline-none focus:border-gold-500">${window.state.settings.scoringGuide}</textarea>
                    </div>
                </div>`;
            }
        };

        // --- Handlers ---
        window.renderSidebarQueue = () => {
            const q = window.state.albums.filter(a => a.tags.includes('To Listen'));
            const el = document.getElementById('sidebar-up-next');
            if (el) el.innerHTML = q.length ? q.map(a => `<div onclick="window.router.navigate('rate', '${a.id}')" class="flex items-center gap-3 p-2 rounded hover:bg-gray-800 cursor-pointer mb-1"><img src="${a.cover}" onerror="UTILS.imgFallback(this)" class="w-8 h-8 rounded object-cover bg-gray-700"><div class="overflow-hidden"><div class="text-xs font-bold truncate">${a.title}</div><div class="text-[10px] text-gray-500 truncate">${getArtist(a.artistId).name}</div></div></div>`).join('') : '<div class="text-xs text-gray-600 italic pl-2">Queue empty</div>';
        };
        window.toggleTypeFilter = (btn) => { btn.classList.toggle('bg-gold-500'); btn.classList.toggle('text-black'); btn.classList.toggle('text-gray-400'); window.Views.refreshAlbumGrid(); };
        window.toggleIconFilter = (btn, color) => { btn.classList.toggle('active-filter'); if (btn.classList.contains('active-filter')) { btn.classList.add(color); btn.classList.remove('text-gray-500'); } else { btn.classList.remove(color); btn.classList.add('text-gray-500'); } window.Views.refreshAlbumGrid(); };
        window.deleteHistoryItem = (dateKey, albumId) => { window.state.history = window.state.history.filter(h => h.date != dateKey); window.Storage.save(); window.Modals.close(); window.Modals.showHistory(albumId); };
        window.updateHistoryDate = (oldDate, newDateStr, albumId) => {
            if (!newDateStr) return;
            const [y, m, d] = newDateStr.split('-').map(Number);
            const newTs = new Date(y, m - 1, d).getTime();
            const h = window.state.history.find(x => x.date == oldDate);
            if (h && !isNaN(newTs)) {
                h.date = newTs;
                window.Storage.save();
                window.Modals.close();
                window.Modals.showHistory(albumId);
            }
        };
        window.addHistoryEntry = (albumId) => { window.Modals.showHistory(albumId); };
        window.submitManualHistory = (albumId) => {
            const dateStr = document.getElementById('hist-date').value;
            const score = parseFloat(document.getElementById('hist-score').value) || 0;
            if (!dateStr) return;
            // Fix: Explicitly parse YYYY-MM-DD to local time to prevent timezone shift
            const [y, m, d] = dateStr.split('-').map(Number);
            const dateTs = new Date(y, m - 1, d).getTime();
            // Don't set oldScore for manual entries to keep UI clean
            window.state.history.push({ date: dateTs, albumId: albumId, score: score, oldScore: null });
            window.Storage.save();
            window.Modals.close();
            window.Modals.showHistory(albumId);
            window.showToast('History added');
        };

        // --- ADDED HANDLERS (REPAIR) ---

        window.updateTrackScore = (albumId, trackIdx, score) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album || !album.tracks[trackIdx]) return;

            album.tracks[trackIdx].score = parseFloat(score) || 0;
            album.score = calculateAlbumScore(album);
            window.Storage.save();

            const inputEl = document.getElementById(`score-input-${trackIdx}`);
            if (inputEl) {
                const colorClass = UTILS.getScoreColor(album.tracks[trackIdx].score).split(' ')[1];
                inputEl.className = `w-full bg-gray-950 border border-gray-700 rounded py-2 text-center font-bold text-lg focus:ring-1 focus:ring-gold-500 focus:outline-none transition-colors duration-200 ${colorClass}`;
            }

            const scoreDisplay = document.getElementById('rating-score-display');
            if (scoreDisplay) {
                scoreDisplay.innerText = album.score;
                const scoreColor = UTILS.getScoreColor(album.score).split(' ')[1];
                scoreDisplay.className = `text-6xl font-black text-white drop-shadow-xl mt-2 ${scoreColor}`;
            }
            updateChart(album);
        };

        window.toggleExcludeDOM = (albumId, trackIdx, btnElement) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album || !album.tracks[trackIdx]) return;

            album.tracks[trackIdx].exclude = !album.tracks[trackIdx].exclude;
            album.score = calculateAlbumScore(album);
            window.Storage.save();

            const row = document.getElementById(`track-row-${trackIdx}`);
            if (row) row.outerHTML = window.renderTrackRow(album, album.tracks[trackIdx], trackIdx);

            const scoreDisplay = document.getElementById('rating-score-display');
            if (scoreDisplay) {
                scoreDisplay.innerText = album.score;
                const scoreColor = UTILS.getScoreColor(album.score).split(' ')[1];
                scoreDisplay.className = `text-6xl font-black text-white drop-shadow-xl mt-2 ${scoreColor}`;
            }
            updateChart(album);
        };

        window.setTrackFlagDOM = (albumId, trackIdx, flagType, btnElement) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album || !album.tracks[trackIdx]) return;

            if (album.tracks[trackIdx].flag === flagType) {
                album.tracks[trackIdx].flag = null;
            } else {
                album.tracks[trackIdx].flag = flagType;
            }
            window.Storage.save();

            const row = document.getElementById(`track-row-${trackIdx}`);
            if (row) row.outerHTML = window.renderTrackRow(album, album.tracks[trackIdx], trackIdx);
        };

        window.toggleTagDOM = (albumId, tag, btnElement) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album) return;

            if (album.tags.includes(tag)) {
                album.tags = album.tags.filter(t => t !== tag);
            } else {
                album.tags.push(tag);
            }
            window.Storage.save();

            let color = 'gray';
            if (tag === 'Redo') color = 'purple';
            if (tag === 'To Listen') color = 'green';

            if (btnElement) btnElement.className = `w-full py-2 rounded text-sm font-bold border transition-all ${window.getButtonClass(album, tag, color)}`;
            if (tag === 'To Listen') window.renderSidebarQueue();
        };

        window.toggleHeartDOM = (albumId, btnElement) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album) return;
            const tag = 'Heart';
            if (album.tags.includes(tag)) album.tags = album.tags.filter(t => t !== tag);
            else album.tags.push(tag);
            window.Storage.save();
            if (btnElement) btnElement.className = `w-full py-2 rounded text-sm font-bold border transition-all ${window.getButtonClass(album, tag, 'red')}`;
        };

        window.toggleAlbumStatus = (albumId) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album) return;
            if (album.status === 'Rated') {
                album.status = 'In Progress';
            } else {
                album.status = 'Rated';
                if (!album.dateRated) album.dateRated = Date.now();
            }
            window.Storage.save();
            window.router.navigate('rate', albumId);
        };

        window.updateAlbumBonus = (albumId, val) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (!album) return;
            album.bonus = parseFloat(val) || 0;
            album.score = calculateAlbumScore(album);
            window.Storage.save();

            const scoreDisplay = document.getElementById('rating-score-display');
            if (scoreDisplay) {
                scoreDisplay.innerText = album.score;
                const scoreColor = UTILS.getScoreColor(album.score).split(' ')[1];
                scoreDisplay.className = `text-6xl font-black text-white drop-shadow-xl mt-2 ${scoreColor}`;
            }
        };

        window.toggleEditMode = (albumId) => {
            window.editMode = !window.editMode;
            window.router.navigate('rate', albumId);
        };

        window.updateTrackName = (albumId, trackIdx, val) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (album && album.tracks[trackIdx]) {
                album.tracks[trackIdx].title = val;
                window.Storage.save();
            }
        };

        window.deleteTrack = (albumId, trackIdx) => {
            if (!confirm('Delete track?')) return;
            const album = window.state.albums.find(a => a.id === albumId);
            if (album) {
                album.tracks.splice(trackIdx, 1);
                album.score = calculateAlbumScore(album);
                window.Storage.save();
                window.router.navigate('rate', albumId);
            }
        };

        window.addNewTrack = (albumId) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (album) {
                album.tracks.push({ title: 'New Track', score: 0, exclude: false, features: [], flag: null });
                album.score = calculateAlbumScore(album);
                window.Storage.save();
                window.router.navigate('rate', albumId);
            }
        };

        window.removeFeature = (albumId, trackIdx, feat) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (album && album.tracks[trackIdx]) {
                let feats = album.tracks[trackIdx].features;
                if (typeof feats === 'string') feats = feats.split(',').filter(x => x);
                if (!Array.isArray(feats)) feats = [];
                album.tracks[trackIdx].features = feats.filter(f => f !== feat);
                window.Storage.save();
                window.router.navigate('rate', albumId);
            }
        };

        window.handleAddFeature = (e, albumId, trackIdx) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = e.target.value.trim();
                if (!val) return;
                const album = window.state.albums.find(a => a.id === albumId);
                if (album && album.tracks[trackIdx]) {
                    let feats = album.tracks[trackIdx].features;
                    if (typeof feats === 'string') feats = feats.split(',').filter(x => x);
                    if (!Array.isArray(feats)) feats = [];
                    feats.push(val);
                    album.tracks[trackIdx].features = feats;
                    window.Storage.save();
                    window.router.navigate('rate', albumId);
                }
            }
        };

        window.updateAlbumMeta = (albumId, field, val) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (album) {
                album[field] = val;
                window.Storage.save();
            }
        };

        window.updateDateRated = (albumId, val) => {
            const album = window.state.albums.find(a => a.id === albumId);
            if (album) {
                album.dateRated = new Date(val).getTime();
                window.Storage.save();
            }
        };

        window.Modals = {
            close: () => { document.getElementById('modal-container').classList.add('hidden'); document.getElementById('modal-container').innerHTML = ''; },
            open: (h) => { const el = document.getElementById('modal-container'); el.innerHTML = h; el.classList.remove('hidden'); },
            editArtist: (id) => {
                const a = getArtist(id);
                window.Modals.open(`<div class="bg-gray-900 rounded-xl p-6 border border-gray-700 w-96 fade-in"><h3 class="font-bold mb-4">Edit Artist</h3><input id="ean" value="${a.name}" class="w-full bg-gray-800 mb-2 p-2 rounded text-white" placeholder="Artist Name"><input id="eai" value="${a.image}" class="w-full bg-gray-800 mb-4 p-2 rounded text-white" placeholder="Image URL"><button onclick="const x=window.state.artists.find(z=>z.id==='${id}');x.name=document.getElementById('ean').value;x.image=document.getElementById('eai').value;window.Storage.save();window.Modals.close();window.router.navigate('artistProfile','${id}')" class="w-full bg-gold-500 p-2 rounded text-black font-bold">Save</button><button onclick="window.Modals.close()" class="w-full mt-2 text-gray-500">Cancel</button></div>`);
            },
            showHistory: (id) => {
                const h = window.state.history ? window.state.history.filter(x => x.albumId === id).sort((a, b) => b.date - a.date) : [];
                const todayStr = new Date().toLocaleDateString('en-CA'); // Local YYYY-MM-DD
                window.Modals.open(`
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-700 fade-in w-96">
                        <h3 class="font-bold mb-4">Edit History</h3>
                        
                        <div class="bg-gray-800 p-3 rounded mb-4 border border-gray-700">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Add History Entry</label>
                            <div class="flex gap-2 mb-2">
                                <input type="date" id="hist-date" value="${todayStr}" class="bg-gray-900 text-white rounded px-2 py-1 text-xs w-full border border-gray-600">
                                <input type="number" id="hist-score" placeholder="0" class="bg-gray-900 text-white rounded px-2 py-1 text-xs w-16 text-center font-bold border border-gray-600">
                            </div>
                            <button onclick="window.submitManualHistory('${id}')" class="w-full bg-blue-600 text-white py-1 rounded text-xs font-bold hover:bg-blue-500">Add Entry</button>
                        </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto text-sm" id="history-list-container">
                        ${h.length ? h.map((entry) => `
                            <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                                <div>
                                    <input type="date" value="${new Date(entry.date).toLocaleDateString('en-CA')}" class="bg-transparent text-gray-400 text-xs" onchange="window.updateHistoryDate(${entry.date}, this.value, '${id}')">
                                    ${entry.oldScore ? `<div class="text-[10px] text-gray-600">Prev: ${entry.oldScore}</div>` : ''}
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" value="${entry.score}" class="w-12 bg-transparent text-right font-bold text-gold-400" onchange="window.updateHistoryScore(${entry.date}, this.value, '${id}')">
                                    <button onclick="window.deleteHistoryItem(${entry.date}, '${id}')" class="text-red-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-500">No history yet.</div>'}
                    </div>
                    <button onclick="window.Modals.close()" class="w-full mt-4 bg-gray-800 text-white py-2 rounded">Close</button>
                </div>
             `);
            },
            openRateStep1: () => {
                window.Modals.open(`<div class="bg-gray-900 p-6 rounded-xl border border-gray-700 w-96 fade-in"><h3 class="font-bold mb-4">Add Album</h3><form onsubmit="window.handleRateStep1(event)"><input name="artist" placeholder="Artist" class="w-full mb-2 bg-gray-800 p-2 rounded text-white" required><input name="album" placeholder="Album" class="w-full mb-2 bg-gray-800 p-2 rounded text-white" required><input name="cover" placeholder="Cover URL" class="w-full mb-2 bg-gray-800 p-2 rounded text-white"><textarea name="tracks" placeholder="Tracks (one per line)" class="w-full mb-4 bg-gray-800 p-2 rounded text-white h-32" required></textarea><div class="grid grid-cols-2 gap-4"><select name="type" class="w-full bg-gray-800 rounded text-white"><option value="Album">Album</option><option value="EP">EP</option><option value="Mixtape">Mixtape</option><option value="Single">Single</option></select><input type="date" name="releaseDate" class="w-full bg-gray-800 rounded text-white" required></div><div class="pt-4 grid grid-cols-2 gap-4"><button type="submit" name="action" value="rate" class="w-full bg-gold-500 text-black font-bold py-2 rounded">Start Rating</button><button type="submit" name="action" value="queue" class="w-full bg-gray-800 text-white font-bold py-2 rounded">Add to Queue</button></div></form><button onclick="window.Modals.close()" class="w-full mt-2 text-gray-500">Cancel</button></div>`);
            },
            openSelectionModal: (type) => {
                window.selType = type;
                window.Modals.open(`
                    <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 w-full max-w-2xl fade-in flex flex-col max-h-[80vh]">
                        <h3 class="font-bold mb-4 text-xl">Select Top 5 ${type === 'albums' ? 'Albums' : 'Artists'}</h3>
                        
                        >                         <div class="mb-4 bg-gray-850 p-3 rounded-lg border border-gray-800">
                            <div class="text-xs font-bold text-gray-500 uppercase mb-2">Current Selection (In Order)</div>
                            <div id="sel-preview" class="grid grid-cols-5 gap-2"></div>
                        </div>
                    <input id="sel-search-input" placeholder="Search ${type}..." oninput="window.renderSelList(this.value)" class="w-full bg-gray-800 rounded p-3 mb-4 text-white border border-gray-700 focus:border-gold-500 outline-none sticky top-0">
                    <div id="sel-list" class="flex-1 overflow-y-auto grid grid-cols-3 md:grid-cols-4 gap-3 p-1"></div>
                    <button onclick="window.Modals.close();window.router.navigate('dashboard')" class="w-full mt-4 bg-gold-500 text-black py-3 rounded font-bold shadow-lg">Done</button>
                </div>
             `);
                window.renderSelList();
            },
            editAlbumDetails: (id) => {
                const album = window.state.albums.find(a => a.id === id);
                if (!album) return;
                const artist = getArtist(album.artistId);
                window.Modals.open(`
                <div class="bg-gray-900 rounded-xl w-full max-w-lg shadow-2xl border border-gray-700 fade-in">
                    <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                        <h3 class="text-xl font-bold">Edit Album Metadata</h3>
                        <button onclick="window.Modals.close()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <form onsubmit="window.handleEditAlbum(event, '${id}')" class="p-6 space-y-4">
                         <div><label class="text-xs font-bold text-gray-500">Artist</label><input type="text" name="artist" required list="artist-list" class="w-full bg-gray-800 rounded px-3 py-2 text-white" value="${artist.name}"></div>
                         <div><label class="text-xs font-bold text-gray-500">Title</label><input type="text" name="album" required class="w-full bg-gray-800 rounded px-3 py-2 text-white" value="${album.title}"></div>
                         <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">Type</label><select name="type" class="w-full bg-gray-800 rounded px-3 py-2 text-white"><option value="Album" ${album.type === 'Album' ? 'selected' : ''}>Album</option><option value="EP" ${album.type === 'EP' ? 'selected' : ''}>EP</option><option value="Mixtape" ${album.type === 'Mixtape' ? 'selected' : ''}>Mixtape</option><option value="Single" ${album.type === 'Single' ? 'selected' : ''}>Single</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Release Date</label><input type="date" name="releaseDate" required class="w-full bg-gray-800 rounded px-3 py-2 text-white" value="${album.releaseDate}"></div>
                         </div>
                         <div><label class="text-xs font-bold text-gray-500">Cover URL</label><input type="url" name="cover" class="w-full bg-gray-800 rounded px-3 py-2 text-white" value="${album.cover}"></div>
                         <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded">Save Changes</button>
                    </form>
                </div>
            `);
            }
        };

        window.renderSelList = (search = '') => {
            const type = window.selType;
            const container = document.getElementById('sel-list');
            const previewContainer = document.getElementById('sel-preview');
            if (!container) return;
            const selectedIds = type === 'albums' ? window.state.settings.customTopAlbums : window.state.settings.customTopArtists;
            // RENDER PREVIEW (Top 5)
            if (previewContainer) {
                previewContainer.innerHTML = selectedIds.map((id, index) => {
                    const item = type === 'albums' ? window.state.albums.find(a => a.id === id) : window.state.artists.find(a => a.id === id);
                    if (!item) return '';
                    const img = type === 'albums' ? item.cover : item.image;
                    return `
                    <div class="relative bg-gray-800 rounded overflow-hidden border border-gold-500/50 group cursor-pointer aspect-square" onclick="window.toggleSelection('${type}', '${id}')" title="Remove">
                        <div class="absolute top-0 left-0 bg-gold-500 text-black font-black text-[10px] px-1.5 py-0.5 z-10 rounded-br">#${index + 1}</div>
                        <img src="${img}" onerror="${type === 'albums' ? 'UTILS.imgFallback(this)' : 'UTILS.artistImgFallback(this)'}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100">
                        <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-times text-white"></i></div>
                    </div>
                `;
                }).join('') + Array(5 - selectedIds.length).fill(0).map((_, i) => `
                <div class="bg-gray-800/50 rounded border border-dashed border-gray-700 flex items-center justify-center text-gray-600 text-xs aspect-square">#${selectedIds.length + i + 1}</div>
            `).join('');
            }
            // MAIN LIST
            let items = type === 'albums' ? window.state.albums.filter(a => a.status === 'Rated') : window.state.artists;
            if (search) items = items.filter(i => (type === 'albums' ? i.title : i.name).toLowerCase().includes(search.toLowerCase()));
            // Sort
            items.sort((a, b) => {
                const aSel = selectedIds.indexOf(a.id);
                const bSel = selectedIds.indexOf(b.id);
                if (aSel > -1 && bSel > -1) return aSel - bSel;
                if (aSel > -1) return -1;
                if (bSel > -1) return 1;
                if (type === 'albums') return b.score - a.score;
                return getArtistAvg(b.id) - getArtistAvg(a.id);
            });
            container.innerHTML = items.map(item => {
                const isSel = selectedIds.includes(item.id);
                const rank = selectedIds.indexOf(item.id) + 1;
                const img = type === 'albums' ? item.cover : item.image;

                if (type === 'artists') {
                    // ARTIST LAYOUT (Profile Style)
                    return `
                    <div onclick="window.toggleSelection('${type}','${item.id}')" 
                         class="cursor-pointer relative flex flex-col items-center p-3 rounded-xl transition-all group border-2 ${isSel ? 'bg-gray-800 border-gold-500' : 'hover:bg-gray-800 border-transparent'}">
                        
                        ${isSel ? `<div class="absolute top-2 right-2 bg-gold-500 text-black font-black text-xs px-1.5 py-0.5 rounded shadow z-10">#${rank}</div>` : ''}
                        
                        <div class="w-24 h-24 rounded-full overflow-hidden border-2 ${isSel ? 'border-gold-500' : 'border-gray-700 group-hover:border-gray-500'} bg-gray-900 mb-2 relative shrink-0 shadow-lg">
                             ${!img ? `<div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-user text-2xl text-gray-600"></i></div>` : ''}
                             <img src="${img}" onerror="UTILS.artistImgFallback(this)" class="w-full h-full object-cover">
                        </div>
                        
                        <div class="text-center w-full min-w-0">
                            <div class="font-bold text-xs truncate text-white" title="${item.name}">${item.name}</div>
                            <div class="text-[10px] text-gray-500">Avg: ${getArtistAvg(item.id)}</div>
                        </div>
                    </div>
                `;
                } else {
                    // ALBUM LAYOUT (Card Style)
                    const mainText = item.title;
                    const subText = getArtist(item.artistId).name;
                    return `
                    <div onclick="window.toggleSelection('${type}','${item.id}')" 
                         class="relative bg-gray-800 rounded-lg overflow-hidden cursor-pointer border-2 transition-all group block ${isSel ? 'border-gold-500 opacity-100 ring-2 ring-gold-500/50' : 'border-gray-800 opacity-60 hover:opacity-100 hover:border-gray-600'}">
                        
                        ${isSel ? `<div class="absolute top-0 right-0 bg-gold-500 text-black font-black text-xs px-2 py-1 z-10 rounded-bl shadow">#${rank}</div>` : ''}
                        
                        <div class="w-full aspect-square bg-gray-900 relative">
                             <img src="${img}" onerror="UTILS.imgFallback(this)" class="w-full h-full object-cover">
                        </div>
                        <div class="p-2 w-full">
                            <div class="font-bold text-xs truncate text-white" title="${mainText}">${mainText}</div>
                            <div class="text-[10px] text-gray-400 truncate">${subText}</div>
                        </div>
                    </div>
                `;
                }
            }).join('');
        };

        window.onload = () => { window.Storage.load(); window.router.navigate('dashboard'); };
        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');

        function initChart(album) {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            let x = 1;
            const data = album.tracks.filter(t => !t.exclude).map(t => ({ x: x++, y: t.score, title: t.title }));
            window.currentChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ data: data, borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', tension: 0.3, fill: true, pointRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: i => i[0].raw.title } } }, scales: { y: { min: 0, max: 110, grid: { color: '#374151' } }, x: { type: 'linear', min: 1, max: data.length || 1, grid: { display: false } } } }
            });
        }
        function updateChart(album) { if (window.currentChart) { let x = 1; const data = album.tracks.filter(t => !t.exclude).map(t => ({ x: x++, y: t.score, title: t.title })); window.currentChart.data.datasets[0].data = data; window.currentChart.options.scales.x.max = Math.max(data.length, 1); window.currentChart.update(); } }

        // FIX: Re-attach Render Songs Logic
        window.Views.renderSongsLogic = window.Views.renderSongsLogicImpl;

        // FIX: Handle Album Rate Logic
        window.handleRateStep1 = (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const action = e.submitter.value; // 'rate' or 'queue'
            const artistName = f.get('artist').trim();

            // Ensure Artist Exists
            let artist = window.state.artists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
            if (!artist) {
                artist = { id: UTILS.generateId(), name: artistName, image: '' };
                window.state.artists.push(artist);
            }

            const tracks = f.get('tracks').split('\n').filter(t => t.trim()).map(t => ({ title: t.trim(), score: 0, exclude: false, features: [], flag: null }));
            const status = action === 'queue' ? 'To Listen' : 'In Progress';
            const tags = action === 'queue' ? ['To Listen'] : ['In Progress'];

            const newAlb = {
                id: UTILS.generateId(),
                title: f.get('album'),
                artistId: artist.id,
                type: f.get('type'),
                releaseDate: f.get('releaseDate'),
                dateRated: status === 'In Progress' ? Date.now() : null,
                cover: f.get('cover'),
                status,
                tags,
                bonus: 0,
                tracks,
                score: 0,
                dateAdded: Date.now()
            };

            window.state.albums.push(newAlb);
            window.Storage.save();
            window.Modals.close();
            window.showToast('Album Created');

            if (action === 'rate') {
                window.router.navigate('rate', newAlb.id);
            } else {
                window.router.navigate('dashboard');
                window.showToast('Added to Queue');
            }
        };

        window.handleEditAlbum = (e, id) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const album = window.state.albums.find(a => a.id === id);
            if (album) {
                const artistName = formData.get('artist').trim();
                let artist = window.state.artists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
                if (!artist) { artist = { id: UTILS.generateId(), name: artistName, image: '' }; window.state.artists.push(artist); }
                album.artistId = artist.id;
                album.title = formData.get('album');
                album.type = formData.get('type');
                album.releaseDate = formData.get('releaseDate');
                album.cover = formData.get('cover');
                window.Storage.save();
                window.Modals.close();
                window.router.navigate('rate', id);
                window.showToast('Album details updated');
            }
        };

        window.deleteAlbumFromGrid = (id) => {
            if (confirm('Are you sure you want to delete this album? This action cannot be undone.')) {
                const idx = window.state.albums.findIndex(a => a.id === id);
                if (idx > -1) {
                    window.state.albums.splice(idx, 1);
                    window.Storage.save();
                    window.Views.refreshAlbumGrid();
                    window.showToast('Album deleted', 'success');
                }
            }
        };

    </script>
</body>

</html>
